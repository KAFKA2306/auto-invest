# Pythonバックエンドスクリプト - 計算詳細

このセクションでは、ダッシュボードに表示されるデータを生成する主要なPythonスクリプトが実行する主な計算について詳しく説明します。

---

### `scripts/fetch_valuation_pdr.py`

**目的**: このスクリプトは、生の金融データ（例：株価指数、無リスク金利、GDPデータ、EPSデータなど）を取得し、一連の計算を実行して株価評価指標を導き出します。これらの結果は `public/data/valuation.json` に保存され、フロントエンドで利用されます。

**行われる主な計算**:

1.  **無リスク金利の処理**:
    *   米連邦準備制度（FRED）から3ヶ月物財務省証券（DGS3MO）の金利データを取得します。
    *   欠損値がある場合は補間（前後から値を埋める）し、年率の金利を日次の金利に換算します。
2.  **GDP成長率の計算**:
    *   FREDから実質国内総生産（GDPC1）のデータを取得します。
    *   GDPの対前年比成長率を計算します（四半期データの場合は4期前との比較）。
    *   日次データに再サンプリングし、不足するデータは直前の値で埋めることで、株価データ系列と期間を合わせます。
3.  **株価指数データの取り扱い**:
    *   StooqからNASDAQ 100 (^NDX) 指数とQQQ ETFの終値を取得します。
    *   NDXとQQQの価格を組み合わせます。NDXデータが少ない場合、QQQデータをNDXの代替（プロキシ）として使用し、最新のNDX水準に合わせて調整します。
    *   結合された指数価格データは `public/data/price_NDX.csv` に保存されます。
4.  **対数リターンと移動平均・標準偏差の計算**:
    *   結合された指数価格の日次対数リターン（日々の価格変動率を自然対数で表したもの）を計算します。
    *   対数リターンの `ROLLING_WINDOW` (20日) 移動平均（`mu`）と移動標準偏差（`sigma`）を計算し、それぞれ年率に換算します（平均は252倍、標準偏差は`sqrt(252)`倍）。
5.  **超過リターンの計算**:
    *   `mu_excess = mu - rf_annual` を計算します。これは、年率換算された対数リターンの平均から年率換算された無リスク金利を差し引いたものです。
6.  **期待リターンの計算**:
    *   無リスク金利に基本的な株式リスクプレミアム（ERP_BASE = 0.01）とモメンタム要素（`erp_momentum`）を加えることで、市場の期待リターンを導き出します。
    *   `erp_momentum` は、上下限を調整した `mu_excess` と `ERP_MOMENTUM_WEIGHT = 0.2` から計算されます。
7.  **成長率の上下限調整**:
    *   長期GDP成長率（`g_long`）が極端な値にならないように、`-0.02` から `0.05` の範囲に収まるように調整します。
8.  **モデル益利回り（Earnings Yield）の計算と調整**:
    *   `model_yield = (expected_return - growth_term)` を計算し、`EY_CLIP = (0.005, 0.12)` の範囲に調整します。
    *   `CALIB_WINDOW` (20日) の中央値と `REF_PE` (32.5) を使用して `model_yield` を調整（バイアス導入）し、モデルの益利回りが参照P/E比率と整合するようにします。
9.  **アンカー系列の作成**:
    *   `model_yield` の安定化のため、`ANCHOR_WINDOW` (30日) の移動中央値と拡張中央値、そして`model_yield`自体を `ANCHOR_WEIGHT = 0.15` で加重平均することで、滑らかなアンカー系列を生成します。
10. **予想EPS（Forward EPS）と予想P/E（Forward P/E）の導出（ロジック変更）**:
    *   **予想EPS**: `eps_actual`（四半期データ）を日次のインデックス（`df.index`）に合わせてリインデックスし、**線形補間** (`.interpolate(method='linear')`) および端のNaN処理 (`.bfill().ffill()`) を適用することで、日次の `forward_eps` 系列を直接生成します。
    *   **予想P/E**: `df` の株価指数（`price_index`）を、上記で生成された日次の `forward_eps` で割ることによって、`forward_pe` を導出します。結果は `PE_CLIP` の範囲に調整されます。
    *   **変更点**: 以前の `model_yield` や `scale_series` を用いた `pe_model` ベースの `forward_pe` 計算ロジックは廃止され、より直接的に「株価 ÷ 予想EPS」で `forward_pe` を決定するようになりました。これにより、`forward_pe` と `forward_eps` のスパイクや不連続性が抑制されます。

11. **益利回りスプレッド**:
    *   `earnings_yield_spread = earnings_yield_proxy - rf_annual` を計算します。これは、株式の益利回りと無リスク金利の差を示します。
12. **EPS成長率 (YoY)**:
    *   `public/data/ndx_eps_quarterly.csv` から読み込まれた四半期EPSデータに基づき、対前年比EPS成長率を計算します。このデータも日次のインデックスに合わせて線形補間され、`df` に統合されます。
13. **最終データフレームとJSONペイロードの構築**:
    *   計算されたすべての系列を最終的なデータフレームにまとめます。
    *   最新の計算値と過去の系列、およびメタデータを含むJSONペイロード（`public/data/valuation.json`）を構築します。

### 最近のバグ修正と改善点 (`scripts/fetch_valuation_pdr.py`)

ユーザーからのフィードバックに基づき、`scripts/fetch_valuation_pdr.py` の株価評価指標の計算ロジックが根本的に見直されました。特に、以前の `forward_pe` のスパイクや `forward_eps` の不連続性の原因となっていた `model_pe` や `scale_series` ベースの計算ロジックを廃止し、以下に示すように変更しています。`ffill()` (前方補間) ではなく、より統計的に適切な線形補間を基本的な補間方法として採用しています。

1.  **予想EPS/P/E導出ロジックの抜本的変更**:
    *   **変更前**: `model_yield` から `pe_model` を計算し、スケーリング因子 `scale_series` で調整して `forward_pe` を導出し、その `forward_pe` と株価から `forward_eps` を逆算していました。このアプローチが `forward_pe` の不連続性や `forward_eps` のスパイクの原因となっていました。
    *   **変更後**: 実際のEPSデータを日次で線形補間することで、直接 `forward_eps` 系列を作成するようになりました。そして、この安定した `forward_eps` と株価指数 (`price_index`) から `forward_pe = price_index / forward_eps` を導出します。これにより、両系列の安定性が大幅に向上し、より直感的な財務指標となりました。
2.  **`bias` 計算におけるNaN処理の堅牢化 (旧Issue 4)**:
    *   `median_window.iloc[-1]` の値を明示的にチェックし、NaNまたはゼロである場合には `bias` を `1.0` に設定するようにロジックを改善しました。これにより、計算の連鎖的なNaN化やデータ破損のリスクを排除しました。
3.  **GDP YoYデータ処理の線形補間化 (旧Issue 6)**:
    *   四半期GDP YoYデータを日次にリサンプリングする際に、`ffill()` ではなく**線形補間** (`.interpolate(method='linear')`) でギャップを埋めるように変更しました。これにより、GDP成長率がより滑らかな時系列データとして扱われ、`model_yield` の変動が自然になりました。

---

### `scripts/update_leverage.py`

**目的**: このスクリプトは、指定された金融商品の株価とリスクフリーレートを取得し、レバレッジ推奨値や様々なリスク・リターン指標を計算します。計算結果は `public/data/metrics.json` に保存され、ダッシュボードで利用されます。

**行われる主な計算**:

1.  **株価系列の取得**:
    *   Stooqから指定された銘柄（例: QQQ, SPY）の終値データを取得します。
2.  **無リスク金利の取得**:
    *   FREDから3ヶ月物財務省証券の金利データを取得し、年率換算された無リスク金利を導出します。
3.  **データのアライメントと前処理**:
    *   株価系列とリスクフリーレートのデータを共通の日付に基づいて調整します。
    *   ダッシュボードのサマリー表示用に、直近 `summary_window_trading_days` (126日) の株価データを抽出します。
4.  **ダッシュボード概要メトリクスの計算 (`summarize` 関数)**:
    *   **リターンの計算**: 期間中の日次価格変化率を計算します。
    *   **超過リターン**: 日次リターンから日次無リスク金利を差し引きます。
    *   **シャープ・レシオ**: 超過リターンから年率シャープ・レシオを計算します（年間の営業日数を252日と仮定）。
    *   **最大ドローダウン**: 累積リターンのピークから谷への最大下落を計算します。
    *   **勝率**: プラスの日次リターンを記録した日の割合を計算します。
    *   **プロフィットファクター**: 期間中の総利益を総損失の絶対値で割った比率を計算します。
5.  **レバレッジ計算 (`backend.services.leverage.py` の `compute_leverage` 関数)**:
    *   この関数は `backend/services/leverage.py` 内にあり、ケリー基準レバレッジ、ボラティリティターゲット型レバレッジ、およびこれらのブレンドによる推奨レバレッジ値を計算します。
    *   入力データとして、共通履歴期間の株価、日次無リスク金利、計算窓サイズ（`window_trading_days = 756`）、借り入れコスト、ファンド手数料、レバレッジ上限、SPX株価などが渡されます。
    *   計算される詳細な指標には、ソルティノ・レシオ、カルマー・レシオ、期待ショートフォール（ES 95%）、ボラティリティのボラティリティ、SPXとのベータ値と相関が含まれます。
6.  **JSON出力**:
    *   計算されたダッシュボード概要メトリクスと詳細なレバレッジメトリクスを結合し、`public/data/metrics.json` にJSON形式で保存します。

---
