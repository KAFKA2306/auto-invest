# Pythonバックエンドスクリプト - 計算詳細

このセクションでは、ダッシュボードに表示されるデータを生成する主要なPythonスクリプトが実行する主な計算について詳しく説明します。

---

## データ取得と処理に関するベストプラクティス（概要）

本プロジェクトでは、金融時系列データを扱う上で以下のベストプラクティスを導入しています。

*   **データソースの信頼性**: Yahoo Finance (`yfinance` ライブラリ経由) を主要な株価データソースとして採用し、過去の `pandas_datareader` (Stooq/Yahoo) に見られたデータ取得の不安定性を解消しています。
*   **連続性のある時系列**: 取得した価格データは、欠損や祝日によるギャップを防ぐため、常に「営業日ベース」で再インデックス化され、線形補間 (`interpolate(method='linear')`) と端のNaN処理 (`bfill().ffill()`) を適用し、連続的で滑らかな系列を生成しています。
*   **堅牢なエラーハンドリング**: 外部データソースからの取得失敗時にもスクリプトがクラッシュしないよう、try-exceptブロックでエラーを捕捉し、空のデータフレームを返すことで後続の処理が継続できるようにしています。
*   **データクリーニング**: 取得したデータは、NaN値、非数値、非正の価格などを厳密にフィルタリングし、計算に適切な品質を確保しています。

---

### `scripts/fetch_valuation_pdr.py`

**目的**: このスクリプトは、株価指数、無リスク金利、GDPデータ、EPSデータなどの生の金融データを取得・処理し、一連の計算を実行して株価評価指標を導き出します。これらの結果は `public/data/valuation.json` に保存され、フロントエンドで利用されます。

**行われる主な計算**:

1.  **株価指数データ取得と前処理**:
    *   `yfinance` を使用してNASDAQ 100 (`^NDX`) とQQQ ETF (`QQQ`) の終値データを取得します。
    *   欠損値の処理、データ型変換、営業日ベースでの連続化と線形補間を適用し、計算に適した価格系列を生成します。
    *   NDXデータが不足する場合にQQQを代理として使用するロジックを含みます。
2.  **無リスク金利とGDP成長率の取得・処理**:
    *   FREDから3ヶ月物財務省証券金利 (`DGS3MO`) と実質GDP (`GDPC1`) データを取得します。
    *   GDP成長率は対前年比(`yoy`)で計算後、日次で線形補間され、滑らかな時系列を生成します。
3.  **EPSデータの処理**:
    *   `public/data/ndx_eps_quarterly.csv` から四半期EPSデータを読み込みます。
    *   日次のインデックスに合わせて線形補間し、連続的な日次EPS系列を生成します。
4.  **対数リターンと移動平均・標準偏差**:
    *   株価指数の日次対数リターンを計算し、`ROLLING_WINDOW` (20日) の移動平均 (`mu`) と移動標準偏差 (`sigma`) を年率換算します。
5.  **超過リターンと期待リターン**:
    *   年率換算された対数リターンと無リスク金利から超過リターン (`mu_excess`) を計算します。
    *   無リスク金利、リスクプレミアム、モメンタム要素を基に市場の期待リターンを算出します。
6.  **モデル益利回り（Earnings Yield）の計算**:
    *   期待リターンと調整済みGDP成長率から `model_yield` を計算し、上下限クリッピングと参照P/Eに基づくバイアス調整を適用します。
    *   `ANCHOR_WINDOW` を用いた移動中央値と拡張中央値により、`model_yield` の安定化を図ります。
7.  **予想EPS（Forward EPS）と予想P/E（Forward P/E）の導出**:
    *   EPSは `eps_actual` を日次で線形補間して直接生成します。
    *   `forward_pe` は `price_index / forward_eps` として計算し、`PE_CLIP` で調整します。
    *   **ポイント**: 以前の `pe_model` や `scale_series` による複雑な補正ロジックは廃止され、より直接的で安定性の高い計算方法に移行しました。
8.  **益利回りスプレッド**:
    *   `earnings_yield_spread = earnings_yield_proxy - rf_annual` を計算します。
9.  **EPS成長率 (YoY)**:
    *   四半期EPSデータから対前年比EPS成長率を計算し、日次で線形補間して利用します。

---

### `scripts/update_leverage.py`

**目的**: このスクリプトは、指定された金融商品（QQQ, SPY）の株価とリスクフリーレートを取得し、レバレッジ推奨値や様々なリスク・リターン指標を計算します。これらの結果は `public/data/metrics.json` に保存され、ダッシュボードで利用されます。

**行われる主な計算**:

1.  **株価系列の取得と前処理**:
    *   `yfinance` を使用してQQQとSPYの終値データを取得します。
    *   `fetch_price_series` 関数内で、データ型変換、NaN値・非正値のフィルタリング、営業日ベースでの連続化と線形補間を適用し、堅牢な価格系列を生成します。
2.  **無リスク金利の取得**:
    *   FREDから3ヶ月物財務省証券金利を取得し、年率換算された無リスク金利を導出します。
3.  **データのアライメント**:
    *   株価系列とリスクフリーレートを共通の日付（`common_index`）に基づいて調整します。共通期間がない場合はエラーを出力し、スクリプトの続行を停止します。
4.  **ダッシュボード概要メトリクスの計算 (`summarize` 関数)**:
    *   直近 `summary_window_trading_days` (126日) の株価データに基づき、以下を計算します。
        *   **シャープ・レシオ**: 超過リターンから年率シャープ・レシオ。
        *   **最大ドローダウン**: 累積リターンの最大下落。
        *   **勝率**: プラスの日次リターンを記録した日の割合。
        *   **プロフィットファクター**: 総利益を総損失で割った比率。
5.  **レバレッジ計算 (`backend.services.leverage.py` の `compute_leverage` 関数)**:
    *   共通履歴期間の株価と無リスク金利、計算窓サイズ（`window_trading_days = 756`）、借り入れコスト、ファンド手数料、レバレッジ上限などを入力とし、ケリー基準レバレッジ、ボラティリティターゲット型レバレッジ、およびこれらのブレンドによる推奨レバレッジ値を計算します。
    *   ソルティノ・レシオ、カルマー・レシオ、期待ショートフォール（ES 95%）、ボラティリティのボラティリティ、SPXとのベータ値と相関といった詳細なリスク指標も導出されます。
6.  **JSON出力**:
    *   計算されたダッシュボード概要メトリクスと詳細なレバレッジメトリクスを結合し、`public/data/metrics.json` にJSON形式で保存します。